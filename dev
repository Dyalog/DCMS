#!/bin/bash

DO_INSTALL=false

while getopts "i" opt; do
    case $opt in
        i) DO_INSTALL=true
    esac
done

if which docker-compose 2>/dev/null ;then
    COMPOSE=$(which docker-compose)
else
    COMPOSE="$(which docker) compose"
fi

## Populate env file
echo APP_DIR=/app > ${PWD}/env
echo HOME=/data >> ${PWD}/env
echo SECRETS=/app/secrets/secrets.json5 >> ${PWD}/env
echo CONFIGFILE=/app/dev.dcfg >> ${PWD}/env
echo HOME=/data >> ${PWD}/env
echo SQL_SERVER=db >> ${PWD}/env
echo SQL_DATABASE=dyalog_cms >> ${PWD}/env
echo SQL_USER=dcms >> ${PWD}/env
echo SQL_PASSWORD=apl >> ${PWD}/env
echo SQL_PORT=3306 >> ${PWD}/env
echo MYSQL_SERVER=db >> ${PWD}/env
echo MYSQL_DATABASE=dyalog_cms >> ${PWD}/env
echo MYSQL_USER=dcms >> ${PWD}/env
echo MYSQL_PASSWORD=apl >> ${PWD}/env
echo MYSQL_PORT=3306 >> ${PWD}/env
echo RIDE_INIT=HTTP:*:4502 >> ${PWD}/env
echo MYSQL_RANDOM_ROOT_PASSWORD=1 >> ${PWD}/env

echo COMPOSE IS: $COMPOSE
echo "Use docker inspect to get the IP of the running container"

$COMPOSE pull

if [ "$DO_INSTALL" = true ]; then
    $COMPOSE -f docker-compose.yml up install
fi

$COMPOSE -f docker-compose.yml up web db
